{% extends "base.html" %}
{% load static %}
{% load template_tags %}

{% block title %}
    {{ post.title }} - Conversate
{% endblock %}

{% block content %}
    <h1>{{ post.title }}</h1>
    <a class="btn btn-sm category" href="{% url 'categories' post.category.slug %}">{{ post.category }}</a>
    <span>{{ post.posted_by }}
        {% if post.edited %}
            <em>(Edited)</em>
        {% endif %}
    </span>
    <br><br>
    {% if post.image and post.image_position == 0 %}
        <img src="{{ post.image.url }}" alt="Image for the post" class="post-image">
    {% endif %}
    <div id="post-content" class="mb-3">{{ post.content|safe }}</div>
    {% if post.image and post.image_position == -1 %}
        <img src="{{ post.image.url }}" alt="Image for the post" class="post-image">
    {% endif %}
    <!-- Poll -->
    {% if post.poll %}
        {% poll_status post.poll.id request.user.id as p_status %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <h5 class="card-title mb-0">{{ post.poll.title }}</h5>
                    {% if post.poll.asked_by == user %}
                        <button class="button-no-style px-1 trigger-delete-poll" type="button"
                            data-url="{% url 'delete_poll' post.poll.id %}">
                            <h5 class="fa-solid fa-trash mb-0 text-muted"></h5>
                        </button>
                    {% endif %}
                </div>
                {% if p_status == 0 and post.posted_by != user %}
                    <form method="POST" class="mt-2" action="{% url 'vote_poll' post.poll.id request.path %}">
                        {% csrf_token %}
                        <ul class="list-group">
                            {% for answer in post.poll.answers.all %}
                                <li class="list-group-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="poll-vote" id="answer-{{ answer.position }}"
                                            value="{{ answer.position }}" required>
                                        <label class="form-check-label" for="answer-{{ answer.position }}">
                                            {{ answer.body }}
                                        </label>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                        <div class="mt-3">
                            <input type="submit" class="btn" value="Vote">
                            <input type="reset" class="btn" value="Clear">
                        </div>
                    </form>
                {% else %}
                    <h6 class="card-subtitle text-muted mb-3">
                        {% with post.poll.number_of_votes as vote_num %}
                            <span>{{ vote_num }} vote{% if vote_num != 1 %}s{% endif %}</span>
                        {% endwith %}
                    </h6>
                    {% for answer in post.poll.answers.all %}
                        <div class="d-flex justify-content-between">
                            <span>{{ answer.body }}</span>
                            {% with answer.number_of_votes as vote_num %}
                                <span>{{ vote_num }} vote{% if vote_num != 1 %}s{% endif %}</span>
                            {% endwith %}
                        </div>
                        <div class="progress mb-3{% if p_status == answer.position %} answer-chosen{% endif %}">
                            {% with answer.vote_percentage as votes %}
                            <div class="progress-bar poll-result"
                                role="progressbar" style="width: 0%;" aria-valuenow="{{ votes }}"
                                aria-valuemin="0" aria-valuemax="100" data-animation="on">{{ votes }}%</div>
                            {% endwith %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="card-footer text-muted">
                {% with post.poll.due_date|date:"d/m/y" as end_date %}
                {% if post.poll.has_expired %}Poll ended {{ end_date }}
                {% else %}Poll ends on {{ end_date }}
                {% endif %}
                {% endwith %}
            </div>
        </div>
    {% endif %}

    <!-- Tags -->
    {% if post.tags %}
        <div id="post-tags">
            {% for tag in post.tag_list %}
                <a class="tag-list-item mr-2 mb-2 p-1 anchor-no-style" href="{% url 'search_tag' tag %}">
                    <em>#{{ tag }}</em>
                </a>
            {% endfor %}
        </div>
    {% endif %}
    <!-- Post footer -->
    <div id="post-footer" class="d-flex justify-content-between mt-2">
        <div class="post-footer-buttons">
            {% if user.is_authenticated %}
            <form class="d-inline" method="POST" action="{% url 'like_post' post.slug %}">
                {% csrf_token %}
                {% if user in post.likes.all %}
                    <button type="submit" class="btn py-0 line-separate" aria-label="Unlike this post">
                        <i class="fa-solid fa-thumbs-up"></i>
                {% else %}
                    <button type="submit" class="btn py-0 line-separate" aria-label="Like this post">
                        <i class="fa-regular fa-thumbs-up"></i>
                {% endif %}
                    {{ post.number_of_likes }}
                </button>
            </form>
            {% else %}
                <span class="btn disabled py-0" aria-disabled="true">
                    <i class="fa-regular fa-thumbs-up"></i>
                    {{ post.number_of_likes }}
                </span>
            {% endif %}
            {% if user.is_authenticated %}
                <a class="btn py-0{% if user == post.posted_by %} line-separate{% endif %}" href="#post-comment" aria-label="Post a comment">
            {% else %}
                <a class="btn py-0{% if user == post.posted_by %} line-separate{% endif %}" href="#comments" aria-label="View the post's comments">
            {% endif %}
                <i class="fa-regular fa-comment"></i>
                {{ post.number_of_comments }}
            </a>
            <!-- Buttons specifically for user-owned posts -->
            {% if user == post.posted_by %}
                <a class="btn py-0 line-separate" href="{% url 'edit_post' post.id %}" aria-label="Edit this post">
                    <i class="fa-solid fa-pen"></i>
                    <span class="d-none d-md-inline">Edit</span>
                </a>
                <button class="btn py-0 trigger-delete-post" aria-label="Delete this post" data-url="{% url 'delete_post' post.slug %}">
                    <i class="fa-solid fa-trash"></i>
                    <span class="d-none d-md-inline">Delete</span>
                </button>
            {% endif %}
        </div>
        <div class="center-to-container">
            <strong>{{ post.posted_on|date:"d/m/y G:i" }}</strong>
        </div>
    </div>
    <br>
    <!-- Comment input when the user is logged in -->
    {% if user.is_authenticated %}
        <form method="POST" action="{% url 'send_comment' post.slug %}">
            {% csrf_token %}
            <label for="comment" class="mb-0 mb-sm-2">
                <h4 class="d-inline-block mb-0 mb-sm-2">Leave a Comment</h4>
            </label>
            <ul class="d-inline-block pl-4">
                <li>Commenting as <em>{{ user.username }}</em></li>
            </ul>
            <div class="form-group mb-1">
                <textarea class="form-control" name="content" id="post-comment" rows="3" required></textarea>
            </div>
            <input type="submit" class="btn" value="Comment"></input>
            <input type="reset" class="btn" value="Clear"></input>
        </form>
    {% endif %}

    <!-- Comments section -->
    <br>
    <div id="comments" class="accordion">
        {% if comments %}
            <h3>Comments</h3>
            <hr>
            <div class="comment-list after-load">
                {% for comment in comments %}
                    {% if comment.reply_to %}
                    <div id="comment-{{ comment.id }}" data-timestamp="{{ comment.posted_on.timestamp }}"
                        data-reply-to="{{ comment.reply_to.id }}" class="comment reply ml-3 ml-sm-4 ml-lg-5 py-3 d-none">
                    {% else %}
                    <div id="comment-{{ comment.id }}" class="comment my-4 py-1">
                    {% endif %}
                        <!-- Comment content -->
                        <div class="comment-header">
                            <strong>{{ comment.posted_by }}</strong> -
                            <em>{{ comment.time_elapsed }}
                                {% if comment.edited %}
                                    (Edited)
                                {% endif %}
                            </em>
                        </div>
                        <div class="comment-body">
                            <p class="mb-1 comment-text">{{ comment.content }}</p>

                            <!-- Menu buttons underneath the comment -->
                            <form method="POST" class="d-inline" action="{% url 'like_comment' comment.id %}">
                                {% csrf_token %}
                                {% if user in comment.likes.all %}
                                <button type="submit" class="btn btn-small py-0">
                                    <i class="fa-solid fa-thumbs-up"></i>
                                {% else %}
                                <button type="submit" class="btn btn-small py-0">
                                    <i class="fa-regular fa-thumbs-up"></i>
                                {% endif %}
                                    {{ comment.number_of_likes }}
                                </button>
                            </form>
                            <button class="btn btn-small py-0" type="button" data-toggle="collapse"
                                data-target="#reply-toggle-{{ comment.id }}" aria-expanded="false" aria-controls="reply-toggle-{{ comment.id }}">
                                <i class="fa-regular fa-comment"></i>
                                Reply
                            </button>
                            {% if user == comment.posted_by %}
                                <button class="btn edit-comment py-0" aria-label="Edit this comment">
                                    <i class="fa-solid fa-pen"></i>
                                    Edit
                                </button>
                                <button class="btn py-0 trigger-delete-comment" aria-label="Delete this comment"
                                    data-url="{% url 'delete_comment' comment.id %}">
                                    <i class="fa-solid fa-trash"></i>
                                    Delete
                                </button>
                            {% endif %}
                            <!-- Reply textarea dropdown -->
                            <form method="POST" action="{% url 'send_comment' post.slug %}" class="collapse reply-collapse" id="reply-toggle-{{ comment.id }}">
                                {% csrf_token %}

                                <!-- Hidden input to tell the view which comment is being replied to -->
                                {% if comment.reply_to %}
                                    <input type="hidden" name="reply" value="{{ comment.reply_to.id }}" aria-hidden="true">
                                {% else %}
                                    <input type="hidden" name="reply" value="{{ comment.id }}" aria-hidden="true">
                                {% endif %}

                                <div class="form-group mb-1">
                                    {% if comment.reply_to and not comment.posted_by == comment.reply_to.posted_by and not comment.posted_by == user %}
                                        <textarea class="form-control reply-to-reply" data-reply-user="{{ comment.posted_by.username }}"
                                            name="content" rows="3" required></textarea>
                                    {% else %}
                                        <textarea class="form-control" name="content" rows="3" required></textarea>
                                    {% endif %}
                                </div>
                                <input type="submit" class="btn" value="Reply"></input>
                                <input type="reset" class="btn" value="Cancel" data-toggle="collapse"
                                    data-target="#reply-toggle-{{ comment.id }}" aria-expanded="false" aria-controls="reply-toggle-{{ comment.id }}"></input>
                            </form>
                            <!-- /.reply -->
                        </div>

                        <!-- Text area to replace comment body when editing -->
                        <form method="POST" action="{% url 'edit_comment' comment.id %}" class="comment-edit-field mb-3 d-none">
                            {% csrf_token %}
                            <div class="form-group mb-1">
                                <textarea class="form-control" name="content" rows="3" required></textarea>
                            </div>
                            <input type="submit" class="btn" value="Save"></input>
                            <button class="btn cancel-edit" type="button">Cancel</button>
                        </form>

                        <!-- Replies section -->
                        {% if comment.number_of_replies %}
                            <a href="#reply-section-{{ comment.id }}" class="reply-toggle d-inline-block mt-2" type="button"
                                data-toggle="collapse" aria-expanded="false" data-control="reply-section-{{ comment.id }}" data-parent="#comments">
                                {% if comment.number_of_replies == 1 %}
                                    View 1 Reply
                                {% else %}
                                    View {{ comment.number_of_replies }} Replies
                                {% endif %}
                            </a>
                            <div id="reply-section-{{ comment.id }}" class="replies collapse" data-parent="#comments"></div>
                        {% endif %}
                    </div>
                    {% if not comment.reply_to %}
                        {% if not forloop.last %}
                            <hr>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                <div class="pre-load">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/comments.js' %}"></script>
{% endblock scripts %}