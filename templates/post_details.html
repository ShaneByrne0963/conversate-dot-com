{% extends "base.html" %}
{% load static %}

{% block title %}
    {{ post.title }} - Conversate
{% endblock %}

{% block content %}
    <h1>{{ post.title }}</h1>
    <a class="btn btn-sm category" href="{% url 'categories' post.category.slug %}">{{ post.category }}</a>
    <span>{{ post.posted_by }}
        {% if post.edited %}
            <em>(Edited)</em>
        {% endif %}
    </span>
    <br><br>
    <div id="post-content" class="mb-5">{{ post.content|safe }}</div>
    <div id="post-footer" class="d-flex justify-content-between">
        <div class="post-footer-buttons">
            {% if user.is_authenticated %}
            <form class="d-inline" method="POST" action="{% url 'like_post' post.slug %}">
                {% csrf_token %}
                {% if liked %}
                    <button type="submit" class="btn py-0 line-separate" aria-label="Unlike this post">
                        <i class="fa-solid fa-thumbs-up"></i>
                {% else %}
                    <button type="submit" class="btn py-0 line-separate" aria-label="Like this post">
                        <i class="fa-regular fa-thumbs-up"></i>
                {% endif %}
                    {{ post.number_of_likes }}
                </button>
            </form>
            {% else %}
                <span class="btn disabled py-0" aria-disabled="true">
                    <i class="fa-regular fa-thumbs-up"></i>
                    {{ post.number_of_likes }}
                </span>
            {% endif %}
            {% if user.is_authenticated %}
                <a class="btn py-0 line-separate" href="#post-comment" aria-label="Post a comment">
            {% else %}
                <a class="btn py-0 line-separate" href="#comments" aria-label="View the post's comments">
            {% endif %}
                <i class="fa-regular fa-comment"></i>
                {{ post.number_of_comments }}
            </a>
            <!-- Buttons specifically for user-owned posts -->
            {% if user == post.posted_by %}
                <a class="btn py-0 line-separate" href="{% url 'edit_post' post.id %}" aria-label="Edit this post">
                    <i class="fa-solid fa-pen"></i>
                    Edit
                </a>
                <button class="btn py-0" aria-label="Delete this post" data-toggle="modal" data-target="#modal-post-delete">
                    <i class="fa-solid fa-trash"></i>
                    Delete
                </button>
            {% endif %}
        </div>
        <div class="center-to-container">
            <strong>{{ post.posted_on|date:"d/m/y G:i" }}</strong>
        </div>
    </div>
    <!-- Modal for deleting post -->
    <div class="modal fade" id="modal-post-delete" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Post Delete</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this post?</p>
                    <p>Deleting this post cannot be undone and will remove all likes and comments.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                        aria-label="Keep post">Cancel</button>
                    <a href="{% url 'delete_post' post.slug %}" class="btn btn-primary"
                        aria-label="Confirm post delete">Delete</a>
                </div>
            </div>
        </div>
    </div>
    <!-- /.modal -->
    <br>
    <!-- Comment input when the user is logged in -->
    {% if user.is_authenticated %}
        <form method="POST" action="{% url 'send_comment' post.slug %}">
            {% csrf_token %}
            <label for="comment" class="mb-0 mb-sm-2">
                <h4 class="d-inline-block mb-0 mb-sm-2">Leave a Comment</h4>
            </label>
            <ul class="d-inline-block pl-4">
                <li>Commenting as <em>{{ user.username }}</em></li>
            </ul>
            <div class="form-group mb-1">
                <textarea class="form-control" name="content" id="post-comment" rows="3" required></textarea>
            </div>
            <input type="submit" class="btn" value="Comment"></input>
            <input type="reset" class="btn" value="Clear"></input>
        </form>
    {% endif %}

    <!-- Comments section -->
    <br>
    <div id="comments" class="accordion">
        {% if comments %}
            <h3>Comments</h3>
            <hr>
            {% for comment in comments %}
                {% if comment.reply_to %}
                <div id="comment-{{ comment.id }}" data-timestamp="{{ comment.posted_on.timestamp }}"
                    data-reply-to="{{ comment.reply_to.id }}" class="comment reply ml-3 ml-sm-4 ml-lg-5 py-3 d-none">
                {% else %}
                <div id="comment-{{ comment.id }}" class="comment my-4 py-1">
                {% endif %}
                    <!-- Comment content -->
                    <div class="comment-header">
                        <strong>{{ comment.posted_by }}</strong> -
                        <em>{{ comment.posted_on }}
                            {% if comment.edited %}
                                (Edited)
                            {% endif %}
                        </em>
                    </div>
                    <div class="comment-body">
                        <p class="mb-1 comment-text">{{ comment.content }}</p>

                        <!-- Menu buttons underneath the comment -->
                        <form method="POST" class="d-inline" action="{% url 'like_comment' comment.id %}">
                            {% csrf_token %}
                            {% if user in comment.likes.all %}
                            <button type="submit" class="btn btn-small py-0">
                                <i class="fa-solid fa-thumbs-up"></i>
                            {% else %}
                            <button type="submit" class="btn btn-small py-0">
                                <i class="fa-regular fa-thumbs-up"></i>
                            {% endif %}
                                {{ comment.number_of_likes }}
                            </button>
                        </form>
                        <button class="btn btn-small py-0" type="button" data-toggle="collapse"
                            data-target="#reply-toggle-{{ comment.id }}" aria-expanded="false" aria-controls="reply-toggle-{{ comment.id }}">
                            <i class="fa-regular fa-comment"></i>
                            Reply
                        </button>
                        {% if user == comment.posted_by %}
                            <button class="btn edit-comment py-0" aria-label="Edit this comment">
                                <i class="fa-solid fa-pen"></i>
                                Edit
                            </button>
                            <button class="btn py-0" aria-label="Delete this comment" data-toggle="modal"
                                data-target="#modal-comment-delete-{{ comment.id }}">
                                <i class="fa-solid fa-trash"></i>
                                Delete
                            </button>

                            <!-- Modal for deleting the comment -->
                            <div class="modal fade" id="modal-comment-delete-{{ comment.id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Confirm Comment Delete</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete this comment?</p>
                                            {% if comment.number_of_replies %}
                                                <p>Deleting this comment will delete all replies to it.</p>
                                            {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                                aria-label="Keep comment">Cancel</button>
                                            <a href="{% url 'delete_comment' comment.id %}" class="btn btn-primary"
                                                aria-label="Confirm comment delete">Delete</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /.modal -->
                        {% endif %}
                        <!-- Reply textarea dropdown -->
                        <form method="POST" action="{% url 'send_comment' post.slug %}" class="collapse reply-collapse" id="reply-toggle-{{ comment.id }}">
                            {% csrf_token %}

                            <!-- Hidden input to tell the view which comment is being replied to -->
                            {% if comment.reply_to %}
                                <input type="hidden" name="reply" value="{{ comment.reply_to.id }}" aria-hidden="true">
                            {% else %}
                                <input type="hidden" name="reply" value="{{ comment.id }}" aria-hidden="true">
                            {% endif %}

                            <div class="form-group mb-1">
                                {% if comment.reply_to and not comment.posted_by == comment.reply_to.posted_by and not comment.posted_by == user %}
                                    <textarea class="form-control reply-to-reply" data-reply-user="{{ comment.posted_by.username }}"
                                        name="content" rows="3" required></textarea>
                                {% else %}
                                    <textarea class="form-control" name="content" rows="3" required></textarea>
                                {% endif %}
                            </div>
                            <input type="submit" class="btn" value="Reply"></input>
                            <input type="reset" class="btn" value="Cancel" data-toggle="collapse"
                                data-target="#reply-toggle-{{ comment.id }}" aria-expanded="false" aria-controls="reply-toggle-{{ comment.id }}"></input>
                        </form>
                        <!-- /.reply -->
                    </div>

                    <!-- Text area to replace comment body when editing -->
                    <form method="POST" action="{% url 'edit_comment' comment.id %}" class="comment-edit-field mb-3 d-none">
                        {% csrf_token %}
                        <div class="form-group mb-1">
                            <textarea class="form-control" name="content" rows="3" required></textarea>
                        </div>
                        <input type="submit" class="btn" value="Save"></input>
                        <button class="btn cancel-edit" type="button">Cancel</button>
                    </form>

                    <!-- Replies section -->
                    {% if comment.number_of_replies %}
                        <a href="#reply-section-{{ comment.id }}" class="reply-toggle d-inline-block mt-2" type="button"
                            data-toggle="collapse" aria-expanded="false" data-control="reply-section-{{ comment.id }}" data-parent="#comments">
                            {% if comment.number_of_replies == 1 %}
                                View 1 Reply
                            {% else %}
                                View {{ comment.number_of_replies }} Replies
                            {% endif %}
                        </a>
                        <div id="reply-section-{{ comment.id }}" class="replies collapse" data-parent="#comments"></div>
                    {% endif %}
                </div>
                {% if not comment.reply_to %}
                    {% if not forloop.last %}
                        <hr>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/comments.js' %}"></script>
{% endblock scripts %}